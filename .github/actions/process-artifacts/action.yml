# .github/actions/process-artifacts/action.yml
name: 'Process Artifacts'
description: 'Process and rename build artifacts'

inputs:
  os:
    description: 'Operating system'
    required: true

runs:
  using: "composite"
  steps:
    - name: Get Package Version
      id: package-version
      shell: bash
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Rename Artifacts with Version
      shell: bash
      run: |
        VERSION="${{ steps.package-version.outputs.version }}"
        OS="${{ inputs.os }}"
        
        # 获取rust目标平台
        case $OS in
          Linux)
            RUST_TARGET="x86_64-unknown-linux-gnu"
            ;;
          Windows)
            RUST_TARGET="x86_64-pc-windows-msvc"
            ;;
          macOS)
            RUST_TARGET="x86_64-apple-darwin"
            ;;
        esac
        
        # 更新构建产物目录路径，包含目标平台信息
        ARTIFACTS_DIR="src-tauri/target/$RUST_TARGET/release/bundle"
        echo "使用构建产物目录: $ARTIFACTS_DIR"
        
        # 如果特定平台目录不存在，尝试使用通用路径
        if [ ! -d "$ARTIFACTS_DIR" ]; then
          echo "特定平台目录不存在，尝试使用通用路径"
          ARTIFACTS_DIR="src-tauri/target/release/bundle"
        fi
        
        case $OS in
          Linux)
            for file in $ARTIFACTS_DIR/deb/*.deb; do
              if [ -f "$file" ]; then
                mv "$file" "${file%.deb}-$VERSION.deb"
              fi
            done
            for file in $ARTIFACTS_DIR/appimage/*.AppImage; do
              if [ -f "$file" ]; then
                mv "$file" "${file%.AppImage}-$VERSION.AppImage"
              fi
            done
            ;;
          Windows)
            for file in $ARTIFACTS_DIR/msi/*.msi; do
              if [ -f "$file" ]; then
                mv "$file" "${file%.msi}-$VERSION.msi"
              fi
            done
            ;;
          macOS)
            # 首先检查DMG目录是否存在
            if [ ! -d "$ARTIFACTS_DIR/dmg" ]; then
              echo "DMG目录不存在，创建目录: $ARTIFACTS_DIR/dmg"
              mkdir -p "$ARTIFACTS_DIR/dmg"
            fi
            
            # 查找DMG文件
            DMG_FILES=$(find "$ARTIFACTS_DIR" -name "*.dmg")
            if [ -z "$DMG_FILES" ]; then
              echo "错误: 没有找到任何DMG文件"
              # 检查app目录是否存在，这是DMG文件的源
              if [ -d "$ARTIFACTS_DIR/macos" ]; then
                echo "找到macos目录，内容如下:"
                ls -la "$ARTIFACTS_DIR/macos"
              fi
              if [ -d "$ARTIFACTS_DIR/app" ]; then
                echo "找到app目录，内容如下:"
                ls -la "$ARTIFACTS_DIR/app"
              fi
              exit 1
            else
              echo "找到以下DMG文件:"
              echo "$DMG_FILES"
              
              # 处理每个找到的DMG文件
              for file in $DMG_FILES; do
                filename=$(basename "$file" .dmg)
                target_file="$ARTIFACTS_DIR/dmg/$filename-$VERSION.dmg"
                echo "重命名: $file -> $target_file"
                mv "$file" "$target_file"
              done
            fi
            ;;
        esac